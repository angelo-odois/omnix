version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: omnix-backend
    restart: unless-stopped
    ports:
      - "8301:8301"
    environment:
      - NODE_ENV=production
      - PORT=8301
      - JWT_SECRET=${JWT_SECRET}
      - FRONTEND_URL=https://omnix.odois.dev
      - BACKEND_URL=https://api-omnix.odois.dev
      - WEBHOOK_URL=https://hook-omnix.odois.dev
      # Email config
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      # Salvy API
      - SALVY_API_URL=${SALVY_API_URL}
      - SALVY_API_KEY=${SALVY_API_KEY}
      - SALVY_TENANT_ID=${SALVY_TENANT_ID}
      # WAHA API
      - WAHA_API_URL=${WAHA_API_URL}
      - WAHA_API_KEY=${WAHA_API_KEY}
      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_PRICE_ID_MONTHLY=${STRIPE_PRICE_ID_MONTHLY}
    networks:
      - omnix-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.omnix-api.rule=Host(`api-omnix.odois.dev`)"
      - "traefik.http.routers.omnix-api.tls=true"
      - "traefik.http.routers.omnix-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.omnix-api.loadbalancer.server.port=8301"
      # Webhook subdomain routing
      - "traefik.http.routers.omnix-webhook.rule=Host(`hook-omnix.odois.dev`)"
      - "traefik.http.routers.omnix-webhook.tls=true"
      - "traefik.http.routers.omnix-webhook.tls.certresolver=letsencrypt"
      - "traefik.http.routers.omnix-webhook.service=omnix-api"
      - "traefik.http.routers.omnix-webhook.middlewares=webhook-path"
      - "traefik.http.middlewares.webhook-path.replacepathregex.regex=^/(.*)"
      - "traefik.http.middlewares.webhook-path.replacepathregex.replacement=/api/waha/webhook/$$1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8301/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=https://api-omnix.odois.dev/api
        - VITE_WEBHOOK_BASE_URL=https://hook-omnix.odois.dev
    container_name: omnix-frontend
    restart: unless-stopped
    ports:
      - "8580:8580"
    networks:
      - omnix-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.omnix-front.rule=Host(`omnix.odois.dev`)"
      - "traefik.http.routers.omnix-front.tls=true"
      - "traefik.http.routers.omnix-front.tls.certresolver=letsencrypt"
      - "traefik.http.services.omnix-front.loadbalancer.server.port=8580"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8580/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  omnix-network:
    driver: bridge